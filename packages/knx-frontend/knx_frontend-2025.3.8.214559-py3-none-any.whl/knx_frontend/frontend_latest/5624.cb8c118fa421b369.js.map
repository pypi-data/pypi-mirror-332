{"version":3,"file":"5624.cb8c118fa421b369.js","sources":["webpack://knx-frontend/./homeassistant-frontend/src/common/decorators/storage.ts","webpack://knx-frontend/./homeassistant-frontend/src/dialogs/tts-try/dialog-tts-try.ts"],"sourcesContent":["import type { UnsubscribeFunc } from \"home-assistant-js-websocket\";\nimport type { ReactiveElement } from \"lit\";\nimport type { InternalPropertyDeclaration } from \"lit/decorators\";\nimport type { ClassElement } from \"../../types\";\n\ntype Callback = (oldValue: any, newValue: any) => void;\n\nclass StorageClass {\n  constructor(storage = window.localStorage) {\n    this.storage = storage;\n    if (storage !== window.localStorage) {\n      // storage events only work for localStorage\n      return;\n    }\n    window.addEventListener(\"storage\", (ev: StorageEvent) => {\n      if (ev.key && this.hasKey(ev.key)) {\n        this._storage[ev.key] = ev.newValue\n          ? JSON.parse(ev.newValue)\n          : ev.newValue;\n        if (this._listeners[ev.key]) {\n          this._listeners[ev.key].forEach((listener) =>\n            listener(\n              ev.oldValue ? JSON.parse(ev.oldValue) : ev.oldValue,\n              this._storage[ev.key!]\n            )\n          );\n        }\n      }\n    });\n  }\n\n  public storage: globalThis.Storage;\n\n  private _storage: Record<string, any> = {};\n\n  private _listeners: Record<string, Callback[]> = {};\n\n  public addFromStorage(storageKey: any): void {\n    if (!this._storage[storageKey]) {\n      const data = this.storage.getItem(storageKey);\n      if (data) {\n        this._storage[storageKey] = JSON.parse(data);\n      }\n    }\n  }\n\n  public subscribeChanges(\n    storageKey: string,\n    callback: Callback\n  ): UnsubscribeFunc {\n    if (this._listeners[storageKey]) {\n      this._listeners[storageKey].push(callback);\n    } else {\n      this._listeners[storageKey] = [callback];\n    }\n    return () => {\n      this.unsubscribeChanges(storageKey, callback);\n    };\n  }\n\n  public unsubscribeChanges(storageKey: string, callback: Callback) {\n    if (!(storageKey in this._listeners)) {\n      return;\n    }\n    const index = this._listeners[storageKey].indexOf(callback);\n    if (index !== -1) {\n      this._listeners[storageKey].splice(index, 1);\n    }\n  }\n\n  public hasKey(storageKey: string): any {\n    return storageKey in this._storage;\n  }\n\n  public getValue(storageKey: string): any {\n    return this._storage[storageKey];\n  }\n\n  public setValue(storageKey: string, value: any): any {\n    const oldValue = this._storage[storageKey];\n    this._storage[storageKey] = value;\n    try {\n      if (value === undefined) {\n        this.storage.removeItem(storageKey);\n      } else {\n        this.storage.setItem(storageKey, JSON.stringify(value));\n      }\n    } catch (_err: any) {\n      // Safari in private mode doesn't allow localstorage\n    } finally {\n      if (this._listeners[storageKey]) {\n        this._listeners[storageKey].forEach((listener) =>\n          listener(oldValue, value)\n        );\n      }\n    }\n  }\n}\n\nconst storages: Record<string, StorageClass> = {};\n\nexport const storage =\n  (options: {\n    key?: string;\n    storage?: \"localStorage\" | \"sessionStorage\";\n    subscribe?: boolean;\n    state?: boolean;\n    stateOptions?: InternalPropertyDeclaration;\n    serializer?: (value: any) => any;\n    deserializer?: (value: any) => any;\n  }): any =>\n  (clsElement: ClassElement) => {\n    const storageName = options.storage || \"localStorage\";\n\n    let storageInstance: StorageClass;\n    if (storageName && storageName in storages) {\n      storageInstance = storages[storageName];\n    } else {\n      storageInstance = new StorageClass(window[storageName]);\n      storages[storageName] = storageInstance;\n    }\n\n    const key = String(clsElement.key);\n    const storageKey = options.key || String(clsElement.key);\n    const initVal = clsElement.initializer\n      ? clsElement.initializer()\n      : undefined;\n\n    storageInstance.addFromStorage(storageKey);\n\n    const subscribeChanges =\n      options.subscribe !== false\n        ? (el: ReactiveElement): UnsubscribeFunc =>\n            storageInstance.subscribeChanges(\n              storageKey!,\n              (oldValue, _newValue) => {\n                el.requestUpdate(clsElement.key, oldValue);\n              }\n            )\n        : undefined;\n\n    const getValue = (): any =>\n      storageInstance.hasKey(storageKey!)\n        ? options.deserializer\n          ? options.deserializer(storageInstance.getValue(storageKey!))\n          : storageInstance.getValue(storageKey!)\n        : initVal;\n\n    const setValue = (el: ReactiveElement, value: any) => {\n      let oldValue: unknown | undefined;\n      if (options.state) {\n        oldValue = getValue();\n      }\n      storageInstance.setValue(\n        storageKey!,\n        options.serializer ? options.serializer(value) : value\n      );\n      if (options.state) {\n        el.requestUpdate(clsElement.key, oldValue);\n      }\n    };\n\n    return {\n      kind: \"method\",\n      placement: \"prototype\",\n      key: clsElement.key,\n      descriptor: {\n        set(this: ReactiveElement, value: unknown) {\n          setValue(this, value);\n        },\n        get() {\n          return getValue();\n        },\n        enumerable: true,\n        configurable: true,\n      },\n      finisher(cls: typeof ReactiveElement) {\n        if (options.state && options.subscribe) {\n          const connectedCallback = cls.prototype.connectedCallback;\n          const disconnectedCallback = cls.prototype.disconnectedCallback;\n          cls.prototype.connectedCallback = function () {\n            connectedCallback.call(this);\n            this[`__unbsubLocalStorage${key}`] = subscribeChanges?.(this);\n          };\n          cls.prototype.disconnectedCallback = function () {\n            disconnectedCallback.call(this);\n            this[`__unbsubLocalStorage${key}`]?.();\n            this[`__unbsubLocalStorage${key}`] = undefined;\n          };\n        }\n        if (options.state) {\n          cls.createProperty(clsElement.key, {\n            noAccessor: true,\n            ...options.stateOptions,\n          });\n        }\n      },\n    };\n  };\n","import { mdiPlayCircleOutline } from \"@mdi/js\";\nimport { css, html, LitElement, nothing } from \"lit\";\nimport { customElement, property, query, state } from \"lit/decorators\";\nimport { storage } from \"../../common/decorators/storage\";\nimport { fireEvent } from \"../../common/dom/fire_event\";\nimport \"../../components/ha-button\";\nimport { createCloseHeading } from \"../../components/ha-dialog\";\nimport \"../../components/ha-textarea\";\nimport type { HaTextArea } from \"../../components/ha-textarea\";\nimport { convertTextToSpeech } from \"../../data/tts\";\nimport type { HomeAssistant } from \"../../types\";\nimport { showAlertDialog } from \"../generic/show-dialog-box\";\nimport type { TTSTryDialogParams } from \"./show-dialog-tts-try\";\nimport \"../../components/ha-circular-progress\";\n\n@customElement(\"dialog-tts-try\")\nexport class TTSTryDialog extends LitElement {\n  @property({ attribute: false }) public hass!: HomeAssistant;\n\n  @state() private _loadingExample = false;\n\n  @state() private _params?: TTSTryDialogParams;\n\n  @state() private _valid = false;\n\n  @query(\"#message\") private _messageInput?: HaTextArea;\n\n  @storage({\n    key: \"ttsTryMessages\",\n    state: false,\n    subscribe: false,\n  })\n  private _messages?: Record<string, string>;\n\n  public showDialog(params: TTSTryDialogParams) {\n    this._params = params;\n    this._valid = Boolean(this._defaultMessage);\n  }\n\n  public closeDialog() {\n    this._params = undefined;\n    fireEvent(this, \"dialog-closed\", { dialog: this.localName });\n  }\n\n  private get _defaultMessage() {\n    const language = this._params!.language?.substring(0, 2);\n    const userLanguage = this.hass.locale.language.substring(0, 2);\n    // Load previous message in the right language\n    if (language && this._messages?.[language]) {\n      return this._messages[language];\n    }\n    // Only display example message if it's interface language\n    if (language === userLanguage) {\n      return this.hass.localize(\"ui.dialogs.tts-try.message_example\");\n    }\n    return \"\";\n  }\n\n  protected render() {\n    if (!this._params) {\n      return nothing;\n    }\n    return html`\n      <ha-dialog\n        open\n        @closed=${this.closeDialog}\n        .heading=${createCloseHeading(\n          this.hass,\n          this.hass.localize(\"ui.dialogs.tts-try.header\")\n        )}\n      >\n        <ha-textarea\n          autogrow\n          id=\"message\"\n          .label=${this.hass.localize(\"ui.dialogs.tts-try.message\")}\n          .placeholder=${this.hass.localize(\n            \"ui.dialogs.tts-try.message_placeholder\"\n          )}\n          .value=${this._defaultMessage}\n          @input=${this._inputChanged}\n          ?dialogInitialFocus=${!this._defaultMessage}\n        >\n        </ha-textarea>\n        ${this._loadingExample\n          ? html`\n              <ha-circular-progress\n                size=\"small\"\n                indeterminate\n                slot=\"primaryAction\"\n                class=\"loading\"\n              ></ha-circular-progress>\n            `\n          : html`\n              <ha-button\n                ?dialogInitialFocus=${Boolean(this._defaultMessage)}\n                slot=\"primaryAction\"\n                .label=${this.hass.localize(\"ui.dialogs.tts-try.play\")}\n                @click=${this._playExample}\n                .disabled=${!this._valid}\n              >\n                <ha-svg-icon\n                  slot=\"icon\"\n                  .path=${mdiPlayCircleOutline}\n                ></ha-svg-icon>\n              </ha-button>\n            `}\n      </ha-dialog>\n    `;\n  }\n\n  private async _inputChanged() {\n    this._valid = Boolean(this._messageInput?.value);\n  }\n\n  private async _playExample() {\n    const message = this._messageInput?.value;\n    if (!message) {\n      return;\n    }\n\n    const platform = this._params!.engine;\n    const language = this._params!.language;\n    const voice = this._params!.voice;\n\n    if (language) {\n      this._messages = {\n        ...this._messages,\n        [language.substring(0, 2)]: message,\n      };\n    }\n\n    this._loadingExample = true;\n\n    const audio = new Audio();\n    audio.play();\n\n    let url;\n    try {\n      const result = await convertTextToSpeech(this.hass, {\n        platform,\n        message,\n        language,\n        options: { voice },\n      });\n      url = result.path;\n    } catch (err: any) {\n      this._loadingExample = false;\n      showAlertDialog(this, {\n        text: `Unable to load example. ${err.error || err.body || err}`,\n        warning: true,\n      });\n      return;\n    }\n    audio.src = url;\n    audio.addEventListener(\"canplaythrough\", () => audio.play());\n    audio.addEventListener(\"playing\", () => {\n      this._loadingExample = false;\n    });\n    audio.addEventListener(\"error\", () => {\n      showAlertDialog(this, { title: \"Error playing audio.\" });\n      this._loadingExample = false;\n    });\n  }\n\n  static styles = css`\n    ha-dialog {\n      --mdc-dialog-max-width: 500px;\n    }\n    ha-textarea,\n    ha-select {\n      width: 100%;\n    }\n    ha-select {\n      margin-top: 8px;\n    }\n    .loading {\n      height: 36px;\n    }\n  `;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"dialog-tts-try\": TTSTryDialog;\n  }\n}\n"],"names":["StorageClass","constructor","storage","window","localStorage","_storage","_listeners","this","addEventListener","ev","key","hasKey","newValue","JSON","parse","forEach","listener","oldValue","addFromStorage","storageKey","data","getItem","subscribeChanges","callback","push","unsubscribeChanges","index","indexOf","splice","getValue","setValue","value","undefined","removeItem","setItem","stringify","_err","storages","options","clsElement","storageName","storageInstance","String","initVal","initializer","subscribe","el","_newValue","requestUpdate","deserializer","kind","placement","descriptor","set","state","serializer","get","enumerable","configurable","finisher","cls","connectedCallback","prototype","disconnectedCallback","call","createProperty","noAccessor","stateOptions","TTSTryDialog","_decorate","customElement","_initialize","_LitElement","F","args","d","decorators","property","attribute","query","params","_params","_valid","Boolean","_defaultMessage","fireEvent","dialog","localName","language","substring","userLanguage","hass","locale","_messages","localize","html","closeDialog","createCloseHeading","_inputChanged","_loadingExample","_playExample","nothing","_messageInput","message","platform","engine","voice","audio","Audio","url","play","convertTextToSpeech","path","err","showAlertDialog","text","error","body","warning","src","title","static","css","LitElement"],"mappings":"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"}