when:
  event: [ push, pull_request ]
  path: [ pyproject.toml, uv.lock, "slidge/**/*.py", "tests/**/*.py" ]

matrix:
  PYTHON_VERSION:
    - "3.11"
    - "3.12"
    - "3.13"

variables:
  - &only-once
    when:
      matrix:
        PYTHON_VERSION: "3.11"
      event: push

steps:
  # This is often a no-op, but since we manually build the woodpecker-slidge:3.x images,
  # their venv may be out of date, even if uv.lock is not modified.
  update-venv:
    image: codeberg.org/slidge/woodpecker-${CI_REPO_NAME}:${PYTHON_VERSION}
    pull: true
    commands:
      - cp -r /venv .venv
      - uv venv --allow-existing .venv
      - uv export > req.txt
      - uv pip install --requirements req.txt

  ruff:
    image: codeberg.org/slidge/woodpecker-${CI_REPO_NAME}:${PYTHON_VERSION}
    commands:
      - ruff check
      - ruff format --check

  mypy:
    image: codeberg.org/slidge/woodpecker-${CI_REPO_NAME}:${PYTHON_VERSION}
    commands:
      - mypy

  test:
    image: codeberg.org/slidge/woodpecker-${CI_REPO_NAME}:${PYTHON_VERSION}
    commands:
      - coverage run -m pytest tests
      - coverage report | tee coverage.txt
      - coverage html

  badge:
    image: codeberg.org/slidge/woodpecker-${CI_REPO_NAME}:${PYTHON_VERSION}
    commands:
      - uv pip install pybadges
      - COVERAGE=$(tail -n1 coverage.txt | awk 'NF>1{print $NF}')
      - python -m pybadges --left-text=coverage --right-text=$COVERAGE --right-color=green > htmlcov/coverage.svg || true
    <<: *only-once

  publish:
    image: codeberg.org/slidge/woodpecker-publish-pages
    pull: true
    settings:
      token:
        from_secret: CODEBERG_TOKEN
      html-root: htmlcov
      prefix: coverage
    <<: *only-once
