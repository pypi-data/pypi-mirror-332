---
# SPDX-FileCopyrightText: 2025 Tymoteusz Blazejczyk <tymoteusz.blazejczyk@tymonx.com>
# SPDX-License-Identifier: Apache-2.0

reuse:
    image: python:latest
    rules:
        - if: $CI_COMMIT_REF_NAME
          when: always
        - when: never
    before_script:
        - pip install --upgrade pip
        - pip install reuse
    script:
        - reuse lint

.ruff:
    image: ghcr.io/astral-sh/ruff:debian-slim
    variables:
        FORCE_COLOR: 1
    rules:
        - if: $CI_COMMIT_REF_NAME
          when: always
        - when: never

ruff-check:
    extends: .ruff
    script:
        - ruff check --output-format=gitlab > code-quality-report.json || true
        - ruff check
    artifacts:
        reports:
            codequality: code-quality-report.json

ruff-format:
    extends: .ruff
    script:
        - ruff format --diff

deploy-pypi-public:
    image: python:latest
    variables:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: $PYPI_API_TOKEN
    rules:
        - if: $CI_COMMIT_TAG
          when: always
        - when: never
    before_script:
        - pip install --upgrade pip
        - pip install build twine
    script:
        - python -m build
        - python -m twine upload dist/*

deploy-pypi-gitlab:
    image: python:latest
    variables:
        TWINE_USERNAME: gitlab-ci-token
        TWINE_PASSWORD: $CI_JOB_TOKEN
    rules:
        - if: $CI_COMMIT_TAG || $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
          when: always
        - when: never
    before_script:
        - pip install --upgrade pip
        - pip install build twine
    script:
        - python -m build
        - python -m twine upload --repository-url "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi" dist/*
